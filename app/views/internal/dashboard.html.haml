- @title = "Dashboard"

- content_for :header do
  - if @grades
    .float-right
      - grade = @grades[:overall].first
      %div.text-right{ style: "font-size: 14px;" }
        %div{ style: "margin-bottom: 10px;" }
          = link_to reports_static_grades_path do
            Report Card
            %span.d-none.d-sm-inline Available
            &raquo;
        %div
          %span.d-none.d-sm-inline Top Site
          = render "reports_static/grade", percent: grade[:percent]
          = grade[:short_name]
  = @title
= render "internal/tabs"
- content_for :sidebar, render("internal/sidebar")

- report = Report.find_by(name: "Randomizations")

- if report
  - scheme_name = "PATS Treatment Assignment"
  - randomization_goal = Report::EXPECTED_RANDOMIZATIONS.last
  - randomization_total = report.report_rows.sum do |row|
    - row.result["count"].to_i
  .jumbotron
    .float-right.text-center
      = link_to reports_static_randomized_path, class: "title-link" do
        %h4.text-muted Randomized
        %h2= number_with_delimiter randomization_total
    %h4.text-muted Scheme
    %h2.mb-3= scheme_name
    - if randomization_total.positive? && randomization_goal.positive?
      - percent = [randomization_total * 100 / randomization_goal, 100].min
      .progress
        .progress-bar.progress-bar-striped.bg-primary{ style: "width: #{percent}%;min-width: 5em;" }= "#{randomization_total} of #{randomization_goal}"
- else
  - if @randomized
    .jumbotron
      .float-right.text-center
        = link_to reports_static_randomized_path, class: "title-link" do
          %h4.text-muted Randomized
          %h2= number_with_delimiter @randomized[:total]
      %h4.text-muted Scheme
      %h2= @randomized[:scheme_name]
      - if @randomized[:total] > 0 && @randomized[:randomization_goal] > 0
        - percent = [@randomized[:total] * 100 / @randomized[:randomization_goal], 100].min
        .progress{ style: "margin-top: 20px;margin-bottom: 0" }
          .progress-bar.progress-bar-striped.bg-primary{ style: "width: #{percent}%;min-width: 5em;" }= "#{@randomized[:total]} of #{@randomized[:randomization_goal]}"

- if report
  = render "reports/chart", report: report if report.report_type == "randomizations_by_site"
- else
  - if @randomized && @randomized[:total] > 0
    .w-100{ style: "margin-bottom: 20px", data: { object: "draw-chart", series: @randomized[:series].to_json, categories: @randomized[:categories].to_json, title: @randomized[:title], yaxis: @randomized[:yaxis], xaxis: @randomized[:xaxis] } }

.row
  .col-md-4
    = link_to reports_static_screened_path, class: "title-link" do
      .jumbotron.text-center
        %h4.text-muted Screened
        .report-number= number_with_delimiter @screened[:total] rescue 0
  .col-md-4
    = link_to reports_static_consented_path, class: "title-link" do
      .jumbotron.text-center
        %h4.text-muted Consented
        .report-number= number_with_delimiter @consented[:total] rescue 0
  .col-md-4
    = link_to reports_static_eligible_path, class: "title-link" do
      .jumbotron.text-center
        %h4.text-muted Eligible
        .report-number= number_with_delimiter @eligible[:total] rescue 0
- if @screened && @screened[:in_pipeline] > 0
  .dashboard-container
    %p
      Note:
      = link_to reports_static_eligibility_status_path do
        %strong= number_with_delimiter @screened[:in_pipeline]
        of the total
        %strong= number_with_delimiter @screened[:total]
        screened
      have not yet been assigned a final eligiblity status.

- if report
  = render "reports/table", report: report
- else
  - if @randomized && @randomized[:table] && @randomized[:table][:total] > 0
    .dashboard-container.dashboard-table
      = render "reports_static/draw_table", table: @randomized[:table]

.jumbotron.jumbotron-custom-text
  - if report
    .mb-3
      Data last updated
      = report.last_cached_at.strftime("%a, %b %-d at %-l:%M %p.")
  - else
    - if @recruitment
      .mb-3
        Data last updated
        = Time.parse(@recruitment[:exported_at]).strftime("%a, %b %-d at %-l:%M %p.")

  = icon("far", "comment")
  Please
  = mail_to ENV["support_email"], "contact us"
  with any questions you may have.
